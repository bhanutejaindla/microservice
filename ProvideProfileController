package com.hashedin.huspark.controller;

import com.hashedin.huspark.dto.ProviderProfileDTO;
import com.hashedin.huspark.model.ProviderProfile;
import com.hashedin.huspark.model.User;
import com.hashedin.huspark.service.ProviderProfileService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/providers")
@RequiredArgsConstructor
public class ProviderProfileController {

    private final ProviderProfileService providerProfileService;

    /**
     * ✅ PROVIDER: Create or update their own profile
     */
    @PostMapping("/profile")
    public ResponseEntity<ProviderProfile> createOrUpdateProfile(
            @AuthenticationPrincipal UserDetails userDetails,
            @RequestBody ProviderProfileDTO dto) {

        String email = userDetails.getUsername();
        ProviderProfile profile = providerProfileService.createOrUpdateProfile(email, dto);
        return ResponseEntity.ok(profile);
    }

    /**
     * ✅ PROVIDER: Get their own profile
     */
    @GetMapping("/profile")
    public ResponseEntity<ProviderProfile> getMyProfile(@AuthenticationPrincipal UserDetails userDetails) {
        String email = userDetails.getUsername();
        ProviderProfile profile = providerProfileService.getProfileByEmail(email);
        return ResponseEntity.ok(profile);
    }

    /**
     * ✅ ADMIN: View all provider profiles
     */
    @GetMapping("/admin/all")
    public ResponseEntity<List<ProviderProfile>> getAllProfiles() {
        return ResponseEntity.ok(providerProfileService.getAllProfiles());
    }

    /**
     * ✅ ADMIN: Approve provider profile
     */
    @PutMapping("/admin/{id}/approve")
    public ResponseEntity<ProviderProfile> approveProvider(@PathVariable Long id) {
        ProviderProfile approved = providerProfileService.approveProvider(id);
        return ResponseEntity.ok(approved);
    }

    /**
     * ✅ ADMIN: Block or unblock provider
     */
    @PutMapping("/admin/{id}/block")
    public ResponseEntity<ProviderProfile> blockProvider(
            @PathVariable Long id,
            @RequestParam boolean block) {

        ProviderProfile updated = providerProfileService.blockProvider(id, block);
        return ResponseEntity.ok(updated);
    }
}
